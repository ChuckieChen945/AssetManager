<!-- 对压缩图片（防止百度云和谐）的查看支持 -->
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>CC Viewer</title>
        <style>
            html,
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
                height: 100%;
            }
            #viewer-container {
                width: 100%;
                height: 100%;
                overflow: hidden;
                position: relative;
                cursor: grab;
                background-color: transparent;
            }
            #viewer {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(1);
                transform-origin: center center;
                max-width: none;
                max-height: none;
                user-select: none;
            }
        </style>
    </head>
    <body>
        <div id="viewer-container">
            <img id="viewer" />
        </div>

        <script>
            const { execFile } = require("child_process");
            const fs = require("fs");
            const path = require("path");
            const os = require("os");

            const urlParams = new URLSearchParams(window.location.search);
            const filePath = urlParams.get("path");
            const uniqueId = urlParams.get("id");
            const viewer = document.getElementById("viewer");
            const container = document.getElementById("viewer-container");

            // 1. 先显示缩略图
            viewer.src = filePath.replace(".priv", "_thumbnail.png");

            // 2. 加载真实图片
            (async function () {
                try {
                    const cacheDir = path.join(
                        os.tmpdir(),
                        "eagle_images_cache"
                    );
                    if (!fs.existsSync(cacheDir))
                        fs.mkdirSync(cacheDir, { recursive: true });

                    const cachedFile = path.join(cacheDir, uniqueId + ".png");
                    if (fs.existsSync(cachedFile)) {
                        viewer.src = cachedFile;
                        return;
                    }

                    const tempExtractDir = path.join(
                        cacheDir,
                        uniqueId + "_tmp"
                    );
                    if (!fs.existsSync(tempExtractDir))
                        fs.mkdirSync(tempExtractDir, { recursive: true });

                    execFile(
                        "7z",
                        ["e", "-y", filePath, "-o" + tempExtractDir],
                        (err) => {
                            if (err) return console.error("解压失败:", err);

                            const files = fs.readdirSync(tempExtractDir);
                            if (files.length !== 1)
                                return console.error("压缩包中不止一张图片");

                            const extractedFile = path.join(
                                tempExtractDir,
                                files[0]
                            );
                            fs.renameSync(extractedFile, cachedFile);
                            fs.rmdirSync(tempExtractDir, { recursive: true });

                            viewer.src = cachedFile;
                        }
                    );
                } catch (e) {
                    console.error(e);
                }
            })();

            // 3. 缩放和平移逻辑
            let scale = 1;
            let isDragging = false;
            let startX = 0,
                startY = 0;
            let offsetX = 0,
                offsetY = 0;
            let initialOffsetX = 0,
                initialOffsetY = 0;

            container.addEventListener("wheel", (e) => {
                e.preventDefault();
                const delta = e.deltaY < 0 ? 0.1 : -0.1;
                scale += delta;
                scale = Math.min(Math.max(scale, 0.1), 5);
                updateTransform();
            });

            container.addEventListener("mousedown", (e) => {
                e.preventDefault(); // 防止选中文本
                isDragging = true;
                startX = e.clientX - offsetX;
                startY = e.clientY - offsetY;
                container.style.cursor = "grabbing";
            });

            window.addEventListener("mouseup", () => {
                // 改成 window，确保拖出容器也能停止
                isDragging = false;
                container.style.cursor = "grab";
            });

            container.addEventListener("mousemove", (e) => {
                if (!isDragging) return;
                offsetX = e.clientX - startX;
                offsetY = e.clientY - startY;
                updateTransform(); // 实时更新
            });

            container.addEventListener("mouseleave", () => {
                isDragging = false;
                container.style.cursor = "grab";
            });

            function updateTransform() {
                viewer.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px)) scale(${scale})`;
            }
        </script>
    </body>
</html>
